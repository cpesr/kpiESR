---
title: "Mise à jour des données"
output: github_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
options(knitr.table.format = "pipe")
library(tidyverse)
library(kpiESR)

spoilerTable <- function(df) {
  cat("\n<details>\n")
  cat("  <summary>Voir les données</summary>\n\n")
  
  print(kableExtra::kable(df, format="pipe"))
  
  cat("\n\n</details>\n")
}

```

```{r data}
etab.21 <- kpiesr_read.etab.2021v1() 
etab.20 <- kpiesr_read.etab.2020v1() 
etab.19 <- kpiesr_read.etab.2019v1()
ens <- kpiesr_read.ens() %>% mutate(Rentrée = as.character(Rentrée))
etu <- kpiesr_read.etu() %>% mutate(Rentrée = as.character(Rentrée))
fin <- kpiesr_read.fin() %>% mutate(Rentrée = as.character(Rentrée))
```

Ce document identifie les correspondances de code UAI entre trois versions
du jeu de donnée sur les établissements (2021, 2020 et 2019), et trois jeux de 
données (enseignants, étudiants et finances).

## Portée

  
```{r portée, results='asis'}
bind_rows(
  etab.21 %>% summarise(data = "etab.21", Nb.uais = n_distinct(UAI)),
  etab.20 %>% summarise(data = "etab.20", Nb.uais = n_distinct(UAI)),
  etab.19 %>% summarise(data = "etab.19", Nb.uais = n_distinct(UAI)),
  ens %>% summarise(data = "ens",
    Rentrée.min = min(Rentrée), Rentrée.max = max(Rentrée), Nb.uais = n_distinct(UAI)),
  etu %>% summarise(data = "etu",
    Rentrée.min = min(Rentrée), Rentrée.max = max(Rentrée), Nb.uais = n_distinct(UAI)),
  fin %>% summarise(data = "fin",
    Rentrée.min = min(Rentrée), Rentrée.max = max(Rentrée), Nb.uais = n_distinct(UAI))
) %>% spoilerTable()
```




```{r checkuais, message=F}
uaijoins <- etab.21 %>% select(UAI, etab.21 = Etablissement) %>% unique() %>%
  full_join(etab.20 %>% select(UAI, etab.20 = Etablissement) %>% unique() ) %>%
  full_join(etab.19 %>% select(UAI, etab.19 = Etablissement) %>% unique() ) %>%
  full_join(ens %>% group_by(UAI) %>% summarise(ens = paste(range(Rentrée), collapse = "-")) %>% unique() ) %>%
  full_join(etu %>% group_by(UAI) %>% summarise(etu = paste(range(Rentrée), collapse = "-")) %>% unique() ) %>%
  full_join(fin %>% group_by(UAI) %>% summarise(fin = paste(range(Rentrée), collapse = "-")) %>% unique() )
```

## Vérification UAIs

### UAI manquants 

```{r uai.manquants, results='asis'}
bind_rows(
  etab.21 %>% filter(is.na(UAI)) %>% transmute(dataset="etab.21",UAI,Etablissement),
  ens %>% filter(is.na(UAI)) %>% transmute(dataset="ens",UAI,Etablissement),
  etu %>% filter(is.na(UAI)) %>% transmute(dataset="etu",UAI,Etablissement),
  fin %>% filter(is.na(UAI)) %>% transmute(dataset="fin",UAI,Etablissement)
  ) %>% spoilerTable()
```

### Universités : valeurs manquantes depuis etab.21

```{r checkuais.na.21, results='asis'}
uaijoins %>%
  filter(str_detect(etab.21,"niversité")) %>%
  filter(is.na(ens)|is.na(etu)|is.na(fin)) %>%
  spoilerTable()
```

```{r etab.lookup.fun}
etab.lookup <- function(etab="aucunetab",uai="aucunuai") {
  etab <- str_to_lower(etab)
  uaijoins %>%
    filter(str_detect(str_to_lower(etab.21),etab)|str_detect(str_to_lower(etab.20),etab)|str_detect(str_to_lower(etab.19),etab)|UAI==uai) %>%
    filter(str_detect(etab.21,"niversité")|str_detect(etab.20,"niversité")|str_detect(etab.19,"niversité")) %>%
    kableExtra::kable(format="pipe")
}
```

<details>
  <summary>Voir détail universités manquantes</summary>

#### Nantes

```{r etab.lookup.nantes}
etab.lookup(uai="0440984F")
```

#### PSL 

```{r etab.lookup.psl}
etab.lookup(etab="Paris sciences et lettres")
```

```{r etab.lookup.dauphine}
etab.lookup(etab="dauphine")
```

#### Montpellier

```{r etab.lookup.montpellier}
etab.lookup(etab="montpellier")
```

#### Clermont

```{r etab.lookup.Clermont}
etab.lookup(etab="Clermont")
```

#### Lille

```{r etab.lookup.Lille}
etab.lookup(etab="Lille")
```

#### Grenoble

```{r etab.lookup.grenoble}
etab.lookup(etab="grenoble")
```

</details>

### Universités : etab.21

```{r checkuais.université.21, results='asis'}
uaijoins %>%
  filter(str_detect(etab.21,"niversité")) %>%
  arrange(etab.21) %>%
  spoilerTable()
```


### Toutes les valeurs manquantes pour les universités

```{r checkuais.na.20-19, results='asis'}
uaijoins %>%
  filter(str_detect(etab.20,"niversité")|str_detect(etab.19,"niversité")) %>%
  filter(is.na(ens)|is.na(etu)|is.na(fin)) %>%
  spoilerTable()
```

### Correspondances UAI

Ces correspondances sont construites manuellement et appliquées aux jeux de données.

```{r checkuai.match, results='asis'}
correspondances.uai <- bind_rows(
  c("from"="0440984F","to"="0442953W", "note"="Changement de statut au 1er janvier 2022"),
  c("from"="0755700N","to"="0756036D", "note"="Potentiel changement de périmètre en 2019"),
  c("from"="0342321N","to"="0342490X", "note"="Changement de statut en 2021"),
  c("from"="0632035V","to"="0632084Y", "note"="Changement de statut en 2020"),
  c("from"="0597065J","to"="0597239Y", "note"="Changement de statut en 2020 et possibles changements de périmètre avant"),
  c("from"="0383493R","to"="0383546Y", "note"="Changement de statut en 2019 et possibles changements de périmètre avant")
)

correspondances.uai %>% spoilerTable()
```



## Non université données complètes

Etablissements non université présents dans etab.21 et les trois jeux de données.

```{r nonuniv.complet, results='asis'}
nonuniv.complet <- uaijoins %>%
  filter(!(str_detect(etab.21,"niversité")|str_detect(etab.20,"niversité")|str_detect(etab.19,"niversité"))) %>%
  filter(!is.na(ens),!is.na(etu),!is.na(fin)) %>%
  arrange(etab.21,etab.20,etab.19) 

nonuniv.complet %>% spoilerTable()
```


## Etablissement des jeux de données, inconnus dans etab.x

```{r checkuais.horsetab, message=F}
etab.uais <- unique(c(etab.21$UAI,etab.20$UAI,etab.19$UAI))
horsetab <- ens %>% group_by(UAI,etab.ens=Etablissement) %>% summarise(ens = paste(range(Rentrée), collapse = "-")) %>% unique() %>%
  full_join(etu %>% group_by(UAI,etab.etu=Etablissement) %>% summarise(etu = paste(range(Rentrée), collapse = "-")) %>% unique() ) %>%
  full_join(fin %>% group_by(UAI,etab.fin=Etablissement) %>% summarise(fin = paste(range(Rentrée), collapse = "-")) %>% unique() ) %>%
  filter(!UAI %in% etab.uais) 
```

```{r checkuais.horsetab.doubleuai, results='asis'}
horsetab %>% 
  filter(str_detect(UAI,";")) %>% 
  mutate(sepUAI = UAI) %>%
  separate_rows(sepUAI,sep = ';') %>%
  rename(doubleUAI = UAI, UAI = sepUAI) %>%
  left_join(etab.21 %>% select(UAI,etab.21=Etablissement)) %>%
  left_join(etab.20 %>% select(UAI,etab.20=Etablissement)) %>%
  left_join(etab.19 %>% select(UAI,etab.19=Etablissement)) %>%
  spoilerTable() 
```


## Wikidata manquants 

```{r wikidata, results='asis'}
etab.21 %>%
  filter(is.na(url.wikidata)) %>%
  arrange(Type) %>% 
  select(UAI,Etablissement, url.wikidata) %>% 
  spoilerTable()
```

Fix manuel :

```{r fixfun}
fix_etab <- function(etab, fixdf) {
  fixdf <- fixdf %>% arrange(UAI)
  etab <- etab %>% arrange(UAI)
  
  etab %>% 
    mutate(across(names(fixdf),
                  ~ replace(.x, UAI %in% fixdf$UAI, fixdf[[cur_column()]])))
}
```

```{r wikidata.fixv, results='asis'}
wikidata.fix <- bind_rows(
  c(UAI="0442953W",url.wikidata="https://www.wikidata.org/entity/Q259388"),  
  c(UAI="0597132G",url.wikidata="https://www.wikidata.org/entity/Q1548539"),
  c(UAI="0342490X",url.wikidata="https://www.wikidata.org/entity/Q776223"),
  c(UAI="0632084Y",url.wikidata="https://www.wikidata.org/entity/Q1319786"),
  c(UAI="0597239Y",url.wikidata="https://www.wikidata.org/entity/Q3551621")
)

 wikidata.fix %>% spoilerTable()
```

## Sigles manquants pour les universités 

### Sigles récupérables sur wikidata

```{r sigles.wikidata.load, results='hide', cache=TRUE}
wikidataESR::wdesr_get_cache()

alias.wikidata <- etab.21 %>%
  fix_etab(wikidata.fix) %>%
  filter(is.na(Sigle), !is.na(url.wikidata)) %>%
  arrange(Type) %>% 
  mutate(wikidata.alias = wikidataESR::wdesr_get_data(str_replace(url.wikidata,"https://www.wikidata.org/entity/",""))$alias) %>%
  select(UAI,Etablissement,Sigle=wikidata.alias) 
```

```{r sigles.wikidata.print, results='asis'}
alias.wikidata %>% spoilerTable()
```

### Sigles toujours manquants

```{r sigles.manquants, results='asis'}
etab.21 %>%
  fix_etab(alias.wikidata) %>%
  filter(is.na(Sigle)) %>%
  arrange(Type) %>% 
  select(UAI,Etablissement,Sigle, url.wikidata) %>% 
  spoilerTable()
```

Correction manuelle :
```{r sigles.manquants.fix, echo=TRUE}
alias.wikidata <- bind_rows(alias.wikidata, c(UAI="0597165T",Etablissement="Junia",Sigle="Junia"))
```



